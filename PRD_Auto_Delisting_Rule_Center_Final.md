# 商品自动下架规则中心产品需求文档 (PRD)

| 文档版本 | V2.0 (Release) |
| :--- | :--- |
| **状态** | **已定稿 (Final)** |
| **发布日期** | 2026-02-09 |
| **面向对象** | 后端开发、前端开发、QA、运营 |

---

## 1. 产品概述 (Overview)

### 1.1 背景与痛点
当前电商交易场景中，商品在特定业务链路（如兑换单、ERP订单）下可能因配置错误、库存同步延迟或接口异常导致履约失败。传统的人工监控与手动下架机制存在以下痛点：
*   **响应滞后**：依赖人工巡检或客诉反馈，平均止损时效 > 30分钟。
*   **覆盖不全**：无法对全量长尾商品进行实时监控。
*   **误伤风险**：缺乏精细化豁免机制，容易误下架核心战略商品。

### 1.2 产品目标
构建一套**配置化、毫秒级、高可用**的自动下架规则引擎。
*   **核心指标**：异常发生后 **< 1秒** 内触发下架决策。
*   **业务价值**：实现 7*24 小时无人值守风控，降低资损风险，提升用户体验。

---

## 2. 核心业务架构 (Core Architecture)

系统遵循 **"三层漏斗"** 决策模型，确保决策的准确性与安全性。

### 2.1 决策漏斗模型
1.  **L1 匹配层 (Match)**：
    *   根据订单上下文 (`Order Type`, `Product Type`) 精准定位唯一生效的规则配置。
2.  **L2 豁免层 (Whitelist)**：
    *   **最高优先级**。若商品命中白名单，直接放行，**终止后续判定**。
3.  **L3 判定层 (Policy)**：
    *   执行具体的规则策略（如错误码匹配、频次阈值计算）。任意策略命中即触发 Action。

### 2.2 核心实体关系 (ER)
*   **规则 (Rule)**：唯一 Key 为 `Order Type` + `Product Type`。一对一绑定。
*   **策略 (Strategy)**：一条规则包含 N 个策略（Strategy），策略间为 **OR** 关系。
*   **白名单 (Whitelist)**：独立于规则存在，全局生效，维度为 `Shop ID` + `SKU ID`。

---

## 3. 详细功能需求 (Functional Requirements)

### 3.1 规则管理 (Rule Management)
#### 3.1.1 规则配置
*   **唯一性约束**：系统需强制校验 `Order Type` + `Product Type` 的组合唯一性。若尝试创建已存在的组合，必须阻断并提示“规则已存在”。
*   **策略互斥**：单条规则内，同一种策略类型（如“错误码阻断”）仅允许配置一个实例，防止逻辑冲突。
*   **策略类型定义**：
    1.  **错误码阻断 (Error Code)**：
        *   逻辑：下单/履约接口返回码 `IN` [配置列表]。
        *   场景：明确的系统报错，如 "Inventory Error"。
    2.  **高频失败熔断 (Failure Rate)**：
        *   逻辑：滑动窗口 `TimeWindow` (秒) 内，失败次数 > `Threshold`。
        *   场景：突发性大面积异常。
    3.  **累计失败熔断 (Total Failure)**：
        *   逻辑：商品上架至今累计失败次数 > `TotalThreshold`。
        *   场景：长尾商品的持续性低频异常。

#### 3.1.2 规则生命周期
*   **启用/禁用 (Toggle)**：
    *   提供开关。禁用状态下，规则配置保留但**不参与计算**。
    *   状态变更需记录操作日志。
*   **编辑/删除**：
    *   删除规则需二次确认（Risk Warning）。

### 3.2 白名单管理 (Whitelist Management)
#### 3.2.1 管控维度
*   采用 **`Shop ID` + `SKU ID`** 双主键模式。
*   **逻辑**：只有当交易上下文中的店铺与商品同时匹配白名单记录时，才视为豁免。

#### 3.2.2 批量导入 (Batch Import)
*   **交互要求**：支持大文本 (Textarea) 粘贴输入，兼容 Excel 两列复制格式。
*   **数据清洗 (Data Cleaning)**：
    *   **自动去重**：提交时需剔除 (1) 输入文本内的重复项 (2) 数据库中已存在的记录。
    *   **格式校验**：自动过滤非数字字符、空行。
    *   **反馈机制**：明确告知用户“成功 N 条，忽略 M 条（重复/格式错误）”。

---

## 4. 关键逻辑与异常处理 (Logic & Edge Cases)

### 4.1 规则生效机制 (Effectiveness)
*   **最终一致性**：规则变更（增删改）写入 DB 后，需通过消息队列 (MQ) 广播至所有计算节点。
*   **本地缓存**：计算节点需维护本地缓存 (Local Cache)，确保在 DB 抖动时仍能提供服务（降级为最后一次成功的配置）。
*   **生效时效**：P99 < 1秒。

### 4.2 异常场景处理
| 场景 | 预期行为 |
| :--- | :--- |
| **规则中心 DB 宕机** | **降级模式**：计算节点使用本地缓存的旧规则继续运行。若无缓存，默认**放行**（Fail-Open），避免误拦核心流量。 |
| **白名单服务超时** | **熔断机制**：若白名单校验超时 (>50ms)，默认视为**未命中白名单**，继续走规则判定（宁可误拦不可漏放，视业务偏好可调整）。 |
| **高并发热点 SKU** | **本地计数**：针对 "高频失败" 策略，采用单机内存计数 + 异步汇总，或 Redis 计数。避免单点数据库压力。 |
| **配置参数非法** | 后端接口层需进行严格校验（如时间窗口不能为负数），防止脏数据污染规则引擎。 |

---

## 5. 数据结构规范 (Data Schema)

### 5.1 规则实体 (Rule)
```json
{
  "rule_id": 1001,
  "order_type": "自营_ERP",  // Enum
  "product_type": "京东商品", // Enum
  "status": "active",       // active, inactive
  "strategies": [
    {
      "type": "error_code",
      "params": { "codes": [1001, 2004] }
    },
    {
      "type": "failure_rate",
      "params": { "window_sec": 60, "threshold": 50 }
    }
  ],
  "operator": "user_admin",
  "updated_at": 1716280000000
}
```

### 5.2 白名单实体 (Whitelist)
```json
{
  "shop_id": "10001",
  "sku_id": "543210",
  "reason": "618 大促主推款",
  "created_by": "user_op",
  "created_at": 1716280000000
}
```

---

## 6. 非功能性需求 (NFR)
*   **QPS**：系统设计需支持单机 QPS > 2000，集群 QPS > 50,000。
*   **延时 (Latency)**：规则判定接口 TP99 < 5ms。
*   **可观测性**：
    *   需提供“下架拦截量”、“白名单命中量”的实时监控看板。
    *   核心拦截动作需输出详细日志（包含 命中规则ID、策略类型、触发阈值）。
