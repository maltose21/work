<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è‡ªåŠ¨ä¸‹æ¶è§„åˆ™ä¸­å¿ƒ V2</title>
    <style>
        :root {
            --sidebar-bg: #001529;
            --sidebar-text: #a6adb4;
            --primary-color: #1890ff;
            --bg-color: #f0f2f5;
            --white: #ffffff;
            --text-color: #333;
            --border-color: #e8e8e8;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --success-color: #52c41a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { display: flex; background-color: var(--bg-color); height: 100vh; color: var(--text-color); }

        /* Sidebar */
        .sidebar { width: 256px; background-color: var(--sidebar-bg); color: var(--sidebar-text); flex-shrink: 0; display: flex; flex-direction: column; }
        .logo { height: 64px; line-height: 64px; padding-left: 24px; font-size: 20px; font-weight: bold; color: var(--white); background-color: #002140; display: flex; align-items: center; }
        .logo-icon { margin-right: 10px; font-size: 24px; }
        .menu { margin-top: 10px; }
        .menu-item { padding: 0 24px; height: 40px; line-height: 40px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; font-size: 14px; }
        .menu-item:hover { color: var(--white); }
        .menu-item.active { background-color: var(--primary-color); color: var(--white); }
        .submenu { background-color: #000c17; }
        .submenu .menu-item { padding-left: 48px; }
        .menu-submenu-title { padding: 0 24px; height: 40px; line-height: 40px; cursor: pointer; color: var(--sidebar-text); display: flex; align-items: center; justify-content: space-between; }
        .menu-submenu-title:hover { color: var(--white); }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 64px; background: var(--white); padding: 0 24px; display: flex; align-items: center; box-shadow: 0 1px 4px rgba(0,21,41,.08); font-size: 14px; color: #666; }
        .breadcrumb { color: #999; }
        .breadcrumb span:last-child { color: #333; font-weight: 500; }
        .content-area { padding: 24px; overflow-y: auto; flex: 1; }
        .card { background: var(--white); padding: 24px; border-radius: 2px; margin-bottom: 24px; }

        /* Tabs */
        .tabs-header { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .tab-item { padding: 12px 24px; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .tab-item:hover { color: var(--primary-color); }
        .tab-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

        /* Forms */
        .search-form { display: flex; flex-wrap: wrap; gap: 24px; margin-bottom: 10px; }
        .form-item { display: flex; align-items: center; }
        .form-label { margin-right: 10px; font-size: 14px; color: #333; }
        .form-input, .form-select { width: 200px; height: 32px; padding: 4px 11px; border: 1px solid var(--border-color); border-radius: 4px; outline: none; transition: all 0.3s; }
        .form-input:hover, .form-select:hover { border-color: #40a9ff; }
        .form-input:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); }
        
        /* Buttons */
        .btn { height: 32px; padding: 0 15px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); background: var(--white); color: var(--text-color); font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .btn-primary:hover { background: #40a9ff; border-color: #40a9ff; }
        .btn-reset { margin-left: 8px; }
        .btn-reset:hover { color: var(--primary-color); border-color: var(--primary-color); }
        
        /* Table */
        .table-container { width: 100%; overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #fafafa; color: rgba(0,0,0,.85); font-weight: 500; text-align: left; padding: 16px; border-bottom: 1px solid var(--border-color); }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); color: #666; }
        tr:hover td { background-color: #fafafa; }
        
        .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 8px; }
        .status-active { background-color: var(--success-color); }
        .status-inactive { background-color: #d9d9d9; }
        
        .action-link { color: var(--primary-color); cursor: pointer; margin-right: 10px; text-decoration: none; }
        .action-link.delete { color: var(--danger-color); }
        .action-link.toggle { color: var(--warning-color); }
        
        .pagination { display: flex; justify-content: flex-end; margin-top: 16px; align-items: center; font-size: 14px; }

        /* Tags */
        .rule-tag { display: inline-block; background: #f5f5f5; border: 1px solid #d9d9d9; border-radius: 2px; padding: 0 7px; font-size: 12px; margin-right: 4px; margin-bottom: 4px; color: rgba(0,0,0,.65); }
        .rule-logic-or { color: #ff9800; font-weight: bold; font-size: 12px; margin: 0 4px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { width: 800px; background: var(--white); border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-size: 16px; font-weight: 500; color: rgba(0,0,0,.85); display: flex; justify-content: space-between; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer { padding: 10px 16px; border-top: 1px solid var(--border-color); text-align: right; background: transparent; }
        .modal-close { cursor: pointer; border: none; background: none; font-size: 16px; }

        /* Rule Builder */
        .rule-builder-item { background: #fafafa; border: 1px solid #e8e8e8; padding: 16px; margin-bottom: 16px; border-radius: 4px; position: relative; }
        .rule-builder-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .rule-title { font-weight: 500; color: #333; }
        .close-rule { color: #999; cursor: pointer; }
        .close-rule:hover { color: var(--danger-color); }
        .add-rule-btn { border-style: dashed; width: 100%; margin-top: 8px; }
        .or-divider { text-align: center; margin: 10px 0; position: relative; }
        .or-divider::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #e8e8e8; z-index: 0; }
        .or-text { background: #fff; padding: 0 10px; color: #ff9800; font-weight: bold; position: relative; z-index: 1; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: #fff; padding: 12px 24px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; display: flex; align-items: center; min-width: 300px; border-left: 4px solid #1890ff; opacity: 0; transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast-icon { margin-right: 12px; font-size: 16px; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }

        /* Error & Loading */
        .form-input.error, .form-select.error { border-color: var(--danger-color); background-color: #fff1f0; }
        .error-msg { color: var(--danger-color); font-size: 12px; margin-top: 4px; display: none; padding-left: 4px; }
        .form-input.error ~ .error-msg, .form-select.error ~ .error-msg { display: block; }
        .btn.loading { position: relative; pointer-events: none; opacity: 0.7; }
        .btn.loading::before { content: ''; position: absolute; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; left: 50%; margin-left: -9px; }
        .btn.loading span { visibility: hidden; }
    </style>
</head>
<body>

    <div class="toast-container" id="toastContainer"></div>

    <div class="sidebar">
        <div class="logo"> <span class="logo-icon">âš¡</span> è§„åˆ™ä¸­å¿ƒ </div>
        <div class="menu">
            <div class="menu-item"> <span>ğŸ“Š æ•°æ®ä¸­å¿ƒ</span> </div>
            <div class="menu-submenu-title"> <span>âš™ï¸ ç³»ç»Ÿç®¡ç†</span> <span>â–¼</span> </div>
            <div class="submenu">
                <div class="menu-item"> ç³»ç»Ÿé…ç½® </div>
                <div class="menu-item active"> è‡ªåŠ¨ä¸‹æ¶è§„åˆ™ </div>
                <div class="menu-item"> æ“ä½œæ—¥å¿— </div>
            </div>
            <div class="menu-item"> <span>ğŸ”” å‘Šè­¦ä¸­å¿ƒ</span> </div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="breadcrumb" id="breadcrumbText"> ç³»ç»Ÿç®¡ç† / <span>è‡ªåŠ¨ä¸‹æ¶è§„åˆ™</span> </div>
        </div>

        <div class="content-area">
            <div class="card">
                <div class="tabs-header">
                    <div class="tab-item active" onclick="switchTab('rules')" id="tabRules">è§„åˆ™é…ç½®</div>
                    <div class="tab-item" onclick="switchTab('whitelist')" id="tabWhitelist">ç™½åå•ç®¡ç†</div>
                </div>

                <!-- RULES TAB -->
                <div class="search-form">
                    <div class="form-item">
                        <span class="form-label">è®¢å•ç±»å‹</span>
                        <select class="form-select">
                            <option value="">å…¨éƒ¨</option>
                            <option value="1">æ™®é€šå…‘æ¢å•</option>
                            <option value="2">è‡ªè¥ erp è®¢å•</option>
                            <option value="3">poperp è®¢å•</option>
                            <option value="4">erp0 å…ƒå•</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <span class="form-label">å•†å“ç±»å‹</span>
                        <select class="form-select">
                            <option value="">å…¨éƒ¨</option>
                            <option value="1">äº¬ä¸œå•†å“</option>
                            <option value="2">ä¼˜æƒ åˆ¸</option>
                            <option value="3">è™šæ‹Ÿå•†å“</option>
                            <option value="4">äº¬è±†</option>
                            <option value="5">è¶…å¸‚å¡çº¢åŒ…</option>
                            <option value="6">äº¬ä¸œå¯„ä»¶</option>
                            <option value="7">äº¬ä¸œå¥åº·é—®è¯Š</option>
                            <option value="8">äº¬ä¸œè¯»ä¹¦</option>
                            <option value="9">çˆ±åº·å›½å®¾ä½“æ£€</option>
                            <option value="10">ç§‘æŠ€åˆ¸</option>
                            <option value="11">PLUSå¼‚ä¸š</option>
                            <option value="12">PLUSåˆ¸åŒ…</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <span class="form-label">è§„åˆ™ID</span>
                        <input type="text" class="form-input" placeholder="è¯·è¾“å…¥è§„åˆ™ID">
                    </div>
                    <div class="form-item" style="flex-direction: row; align-items: flex-end;">
                        <button class="btn btn-primary">æŸ¥è¯¢</button>
                        <button class="btn btn-reset">é‡ç½®</button>
                    </div>
                </div>

                <div class="action-bar" style="padding-top: 24px; border-top: 1px solid #f0f0f0; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="openRuleModal()">+ æ–°å»ºè§„åˆ™</button>
                </div>
                
                <div class="table-container">
                    <table id="rulesTable">
                        <thead>
                            <tr>
                                <th>è§„åˆ™ID</th>
                                <th>è®¢å•ç±»å‹</th>
                                <th>å•†å“ç±»å‹</th>
                                <th style="width: 40%;">è§„åˆ™è¯¦æƒ… 
                                    <div class="tooltip">â“˜
                                        <span class="tooltip-text">æ»¡è¶³åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€é¡¹ç­–ç•¥å³è§¦å‘ä¸‹æ¶ (OR é€»è¾‘)</span>
                                    </div>
                                </th>
                                <th>çŠ¶æ€</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                                <th>æ“ä½œäºº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="rulesEmpty" class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— è§„åˆ™æ•°æ®</div>
                    </div>
                </div>
                    <div class="pagination" id="rulesPagination"></div>
                </div>

                <!-- WHITELIST TAB -->
                <div id="contentWhitelist" style="display: none;">
                    <div class="search-form">
                        <div class="form-item">
                            <span class="form-label">åº—é“º ID:</span>
                            <input type="text" class="form-input" placeholder="è¯·è¾“å…¥åº—é“ºID">
                        </div>
                        <div class="form-item">
                            <span class="form-label">SKU ID:</span>
                            <input type="text" class="form-input" placeholder="è¯·è¾“å…¥å•†å“ID">
                        </div>
                        <div class="form-item">
                            <button class="btn btn-primary">æŸ¥è¯¢</button>
                        </div>
                    </div>

                    <div class="action-bar" style="padding-top: 24px; border-top: 1px solid #e8e8e8;">
                        <button class="btn btn-primary" onclick="openWhitelistModal()">+ æ‰¹é‡æ·»åŠ ç™½åå•</button>
                        <span style="margin-left: 10px; color: #999; font-size: 12px;">* ç™½åå•ä¸­çš„å•†å“å°†è±å…æ‰€æœ‰è‡ªåŠ¨ä¸‹æ¶è§„åˆ™ (ç»´åº¦: åº—é“º + SKU)</span>
                    </div>
                    
                    <div class="table-container">
                        <table id="whitelistTable">
                            <thead>
                                <tr>
                                    <th>åº—é“º ID</th>
                                    <th>SKU ID</th>
                                    <th>å•†å“åç§°</th>
                                    <th>å¤‡æ³¨è¯´æ˜</th>
                                    <th>æ·»åŠ äºº</th>
                                    <th>æ·»åŠ æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="whitelistPagination"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Rule Modal -->
    <div class="modal-overlay" id="ruleModal">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle">æ–°å»ºè‡ªåŠ¨ä¸‹æ¶è§„åˆ™</span>
                <button class="modal-close" onclick="closeRuleModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="search-form" style="display: block;">
                    <div class="form-item" style="margin-bottom: 20px; align-items: flex-start;">
                        <span class="form-label" style="width: 80px; text-align: right; margin-top: 6px;">è®¢å•ç±»å‹:</span>
                        <div style="flex: 1;">
                            <select class="form-select" style="width: 100%;" id="modalOrderType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="æ™®é€šå…‘æ¢å•">æ™®é€šå…‘æ¢å•</option>
                                <option value="è‡ªè¥ erp è®¢å•">è‡ªè¥ erp è®¢å•</option>
                                <option value="poperp è®¢å•">poperp è®¢å•</option>
                                <option value="erp0 å…ƒå•">erp0 å…ƒå•</option>
                            </select>
                            <div class="error-msg">è¯·é€‰æ‹©è®¢å•ç±»å‹</div>
                        </div>
                    </div>
                    <div class="form-item" style="margin-bottom: 20px; align-items: flex-start;">
                        <span class="form-label" style="width: 80px; text-align: right; margin-top: 6px;">å•†å“ç±»å‹:</span>
                        <div style="flex: 1;">
                            <select class="form-select" style="width: 100%;" id="modalProductType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="äº¬ä¸œå•†å“">äº¬ä¸œå•†å“</option>
                                <option value="ä¼˜æƒ åˆ¸">ä¼˜æƒ åˆ¸</option>
                                <option value="è™šæ‹Ÿå•†å“">è™šæ‹Ÿå•†å“</option>
                                <option value="äº¬è±†">äº¬è±†</option>
                                <option value="è¶…å¸‚å¡çº¢åŒ…">è¶…å¸‚å¡çº¢åŒ…</option>
                                <option value="äº¬ä¸œå¯„ä»¶">äº¬ä¸œå¯„ä»¶</option>
                                <option value="äº¬ä¸œå¥åº·é—®è¯Š">äº¬ä¸œå¥åº·é—®è¯Š</option>
                                <option value="äº¬ä¸œè¯»ä¹¦">äº¬ä¸œè¯»ä¹¦</option>
                                <option value="çˆ±åº·å›½å®¾ä½“æ£€">çˆ±åº·å›½å®¾ä½“æ£€</option>
                                <option value="ç§‘æŠ€åˆ¸">ç§‘æŠ€åˆ¸</option>
                                <option value="PLUSå¼‚ä¸š">PLUSå¼‚ä¸š</option>
                                <option value="PLUSåˆ¸åŒ…">PLUSåˆ¸åŒ…</option>
                            </select>
                            <div class="error-msg">è¯·é€‰æ‹©å•†å“ç±»å‹</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; border-top: 1px solid #e8e8e8; padding-top: 20px;">
                        <h4 style="margin-bottom: 16px; color: #333;">ä¸‹æ¶ç­–ç•¥é…ç½® (æ»¡è¶³ä»»æ„æ¡ä»¶è§¦å‘)</h4>
                        <div class="error-msg" id="ruleListError" style="margin-bottom: 10px;">è¯·è‡³å°‘é…ç½®ä¸€æ¡è§„åˆ™ç­–ç•¥</div>
                        
                        <div id="ruleList"></div>

                        <button class="btn add-rule-btn" onclick="showAddRuleMenu(this)">+ æ·»åŠ ç­–ç•¥ (OR)</button>
                        <div id="addRuleMenu" style="display:none; position: absolute; background: #fff; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; width: 200px; border-radius: 4px; margin-top: 5px;">
                            <div class="menu-item" onclick="addRuleItem('code')" id="menuItem_code">ğŸ”´ é”™è¯¯ç é˜»æ–­</div>
                            <div class="menu-item" onclick="addRuleItem('rate')" id="menuItem_rate">âš¡ é«˜é¢‘å¤±è´¥ç†”æ–­</div>
                            <div class="menu-item" onclick="addRuleItem('total')" id="menuItem_total">ğŸ“ˆ ç´¯è®¡å¤±è´¥ç†”æ–­</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-reset" onclick="closeRuleModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btnSaveRule" onclick="saveRule()"><span>ç¡®å®š</span></button>
            </div>
        </div>
    </div>

    <!-- Whitelist Modal -->
    <div class="modal-overlay" id="whitelistModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <span>æ‰¹é‡æ·»åŠ ç™½åå•</span>
                <button class="modal-close" onclick="closeWhitelistModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-item" style="margin-bottom: 10px;">
                    <span class="form-label" style="width: 100px; text-align: right; align-self: flex-start; margin-top: 6px;">æ•°æ®å½•å…¥:</span>
                    <div style="flex: 1;">
                        <textarea class="form-input" id="whitelistBatchInput" style="width: 100%; height: 200px; padding: 12px; font-family: monospace; line-height: 1.5; font-size: 13px;" placeholder="è¯·ç²˜è´´æ•°æ®ï¼Œæ¯è¡Œä¸€æ¡ã€‚æ”¯æŒæ ¼å¼ï¼š&#10;1. åº—é“ºID, SKU ID (é€—å·åˆ†éš”)&#10;2. åº—é“ºID  SKU ID (ç©ºæ ¼æˆ–Tabåˆ†éš”)&#10;&#10;ç¤ºä¾‹:&#10;1001, 100008348542&#10;2055  100012345678"></textarea>
                        <div style="font-size: 12px; color: #666; margin-top: 8px; background: #f5f5f5; padding: 8px; border-radius: 4px;">
                            ğŸ’¡ æç¤ºï¼šæ”¯æŒä» Excel ç›´æ¥å¤åˆ¶ä¸¤åˆ—æ•°æ® (åº—é“ºID | SKU ID) ç²˜è´´è‡³æ­¤ã€‚
                        </div>
                    </div>
                </div>
                <div class="form-item" style="margin-bottom: 20px;">
                    <span class="form-label" style="width: 100px; text-align: right; align-self: flex-start; margin-top: 6px;">ç»Ÿä¸€å¤‡æ³¨:</span>
                    <div style="flex: 1;">
                        <textarea class="form-input" id="whitelistRemark" style="width: 100%; height: 60px; padding: 8px;" placeholder="è¯·è¾“å…¥è±å…åŸå›  (å¦‚: å¤§ä¿ƒä¸»æ¨æ¬¾)"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-reset" onclick="closeWhitelistModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btnSaveWhitelist" onclick="saveWhitelistBatch()">ç¡®å®šæ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let rulesData = [
            { 
                id: 1001, 
                activity: 'æ™®é€šå…‘æ¢å•', 
                product: 'ä¼˜æƒ åˆ¸', 
                descHTML: '<span class="rule-tag">Code IN [121]</span><span class="rule-logic-or">OR</span><span class="rule-tag">1åˆ†é’Ÿå¤±è´¥ > 1000æ¬¡</span>',
                status: 'active',
                updateTime: '2024-05-20 14:30:00',
                operator: 'wangxianhui6'
            },
            { 
                id: 1002, 
                activity: 'è‡ªè¥ erp è®¢å•', 
                product: 'äº¬ä¸œå•†å“', 
                descHTML: '<span class="rule-tag">Code IN [234, 502]</span>',
                status: 'active',
                updateTime: '2024-05-21 09:15:00',
                operator: 'lixuan128'
            }
        ];

        let whitelistData = [
            { shopId: '1001', skuId: '100008348542', name: 'Apple iPhone 15 Pro Max', remark: 'å¤§ä¿ƒæ ¸å¿ƒä¸»æ¨æ¬¾', operator: 'admin', time: '2024-06-01 10:00:00' },
            { shopId: '2055', skuId: '100012345678', name: 'äº¬ä¸œEå¡ 1000å…ƒ', remark: 'æˆ˜ç•¥åˆä½œå•†å“', operator: 'system', time: '2024-06-02 11:20:00' }
        ];

        // --- INIT ---
        window.onload = function() {
            renderRulesTable();
            renderWhitelistTable();
        };

        // --- COMMON UTILS ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'âœ…' : (type === 'error' ? 'âŒ' : 'âš ï¸');
            toast.innerHTML = `<span class="toast-icon">${icon}</span>${msg}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function switchTab(tabName) {
            const rulesContent = document.getElementById('contentRules');
            const whitelistContent = document.getElementById('contentWhitelist');
            const tabRules = document.getElementById('tabRules');
            const tabWhitelist = document.getElementById('tabWhitelist');

            if (tabName === 'rules') {
                rulesContent.style.display = 'block';
                whitelistContent.style.display = 'none';
                tabRules.classList.add('active');
                tabWhitelist.classList.remove('active');
            } else {
                rulesContent.style.display = 'none';
                whitelistContent.style.display = 'block';
                tabRules.classList.remove('active');
                tabWhitelist.classList.add('active');
            }
        }

        // --- RULES LOGIC ---
        function renderRulesTable() {
            const tbody = document.querySelector('#rulesTable tbody');
            tbody.innerHTML = '';
            
            rulesData.forEach(rule => {
                const tr = document.createElement('tr');
                const statusHtml = rule.status === 'active' 
                    ? '<span class="status-dot status-active"></span><span class="status-text">å¯ç”¨</span>'
                    : '<span class="status-dot status-inactive"></span><span class="status-text">ç¦ç”¨</span>';
                
                const toggleAction = rule.status === 'active' 
                    ? `<a class="action-link toggle" onclick="toggleRuleStatus(${rule.id})">ç¦ç”¨</a>`
                    : `<a class="action-link" onclick="toggleRuleStatus(${rule.id})">å¯ç”¨</a>`;

                tr.innerHTML = `
                    <td>${rule.id}</td>
                    <td>${rule.activity}</td>
                    <td>${rule.product}</td>
                    <td>${rule.descHTML}</td>
                    <td>${statusHtml}</td>
                    <td>${rule.updateTime}</td>
                    <td>${rule.operator}</td>
                    <td>
                        ${toggleAction}
                        <a class="action-link" onclick="showToast('åŸå‹æ¼”ç¤ºï¼šç¼–è¾‘åŠŸèƒ½æš‚æœªå®ç°', 'warning')">ç¼–è¾‘</a>
                        <a class="action-link delete" onclick="deleteRule(${rule.id})">åˆ é™¤</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('rulesPagination').innerHTML = `<span>å…±æœç´¢åˆ° ${rulesData.length} æ¡æ•°æ®</span>`;
        }

        function openRuleModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å»ºè‡ªåŠ¨ä¸‹æ¶è§„åˆ™';
            document.getElementById('modalOrderType').value = '';
            document.getElementById('modalProductType').value = '';
            document.getElementById('ruleList').innerHTML = '';
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            addRuleItem('code'); // Default item
            document.getElementById('ruleModal').style.display = 'flex';
        }

        function closeRuleModal() { document.getElementById('ruleModal').style.display = 'none'; }

        function toggleRuleStatus(id) {
            const rule = rulesData.find(r => r.id === id);
            if (rule) {
                const action = rule.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨';
                if (confirm(`ç¡®å®šè¦${action}è¯¥è§„åˆ™å—ï¼Ÿ`)) {
                    rule.status = rule.status === 'active' ? 'inactive' : 'active';
                    renderRulesTable();
                    showToast(`è§„åˆ™å·²${action}`, 'success');
                }
            }
        }

        function deleteRule(id) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¯¥è§„åˆ™å—ï¼Ÿåˆ é™¤åå°†ç«‹å³åœæ­¢ç›‘æ§ï¼')) {
                rulesData = rulesData.filter(r => r.id !== id);
                renderRulesTable();
                showToast('è§„åˆ™å·²åˆ é™¤', 'success');
            }
        }

        // --- RULE BUILDER ---
        function showAddRuleMenu(btn) {
            const menu = document.getElementById('addRuleMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                // Mutex logic
                const currentTypes = Array.from(document.querySelectorAll('.rule-builder-item')).map(item => item.dataset.type);
                const updateMenuItem = (id, type) => {
                    const el = document.getElementById(id);
                    if (currentTypes.includes(type)) {
                        el.style.opacity = '0.5';
                        el.style.pointerEvents = 'none';
                        if (!el.innerText.includes('(å·²æ·»åŠ )')) el.innerText += ' (å·²æ·»åŠ )';
                    } else {
                        el.style.opacity = '1';
                        el.style.pointerEvents = 'auto';
                        el.innerText = el.innerText.replace(' (å·²æ·»åŠ )', '');
                    }
                };
                updateMenuItem('menuItem_code', 'code');
                updateMenuItem('menuItem_rate', 'rate');
                updateMenuItem('menuItem_total', 'total');
                menu.style.display = 'block';
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.add-rule-btn') && !e.target.closest('#addRuleMenu')) {
                document.getElementById('addRuleMenu').style.display = 'none';
            }
        });

        function addRuleItem(type) {
            const ruleList = document.getElementById('ruleList');
            const items = ruleList.querySelectorAll('.rule-builder-item');
            
            if (items.length > 0) {
                const divider = document.createElement('div');
                divider.className = 'or-divider';
                divider.innerHTML = '<span class="or-text">OR</span>';
                ruleList.appendChild(divider);
            }

            const div = document.createElement('div');
            div.className = 'rule-builder-item';
            div.dataset.type = type;

            let content = '';
            if (type === 'code') {
                content = `
                    <div class="rule-builder-header"><span class="rule-title">ğŸ”´ é”™è¯¯ç é˜»æ–­</span><span class="close-rule" onclick="removeRuleItem(this)">âœ•</span></div>
                    <div class="form-item"><span class="form-label">ç›‘æµ‹é”™è¯¯ç :</span><div style="flex:1"><input type="text" class="form-input code-input" style="width:100%" placeholder="å¦‚: 121, 500"><div class="error-msg">è¯·è¾“å…¥æœ‰æ•ˆçš„é”™è¯¯ç </div></div></div>
                `;
            } else if (type === 'rate') {
                content = `
                    <div class="rule-builder-header"><span class="rule-title">âš¡ é«˜é¢‘å¤±è´¥ç†”æ–­</span><span class="close-rule" onclick="removeRuleItem(this)">âœ•</span></div>
                    <div class="form-item"><input type="number" class="form-input time-input" value="60" style="width:80px;margin-right:8px"><span class="form-label">ç§’å†…ï¼Œå¤±è´¥ ></span><input type="number" class="form-input count-input" value="1000" style="width:100px"><span class="form-label">æ¬¡</span></div>
                `;
            } else if (type === 'total') {
                content = `
                    <div class="rule-builder-header"><span class="rule-title">ğŸ“ˆ ç´¯è®¡å¤±è´¥ç†”æ–­</span><span class="close-rule" onclick="removeRuleItem(this)">âœ•</span></div>
                    <div class="form-item"><span class="form-label">ç´¯è®¡å¤±è´¥ ></span><input type="number" class="form-input total-input" value="10000" style="width:150px"><span class="form-label">æ¬¡</span></div>
                `;
            }
            div.innerHTML = content;
            ruleList.appendChild(div);
            document.getElementById('addRuleMenu').style.display = 'none';
        }

        function removeRuleItem(btn) {
            const item = btn.closest('.rule-builder-item');
            const prev = item.previousElementSibling; 
            const next = item.nextElementSibling;
            item.remove();
            if (prev && prev.classList.contains('or-divider')) prev.remove();
            else if (next && next.classList.contains('or-divider') && !item.previousElementSibling) next.remove();
        }

        function saveRule() {
            // Validation
            const actType = document.getElementById('modalOrderType');
            const prodType = document.getElementById('modalProductType');
            let isValid = true;

            if (!actType.value) { actType.classList.add('error'); isValid = false; } else actType.classList.remove('error');
            if (!prodType.value) { prodType.classList.add('error'); isValid = false; } else prodType.classList.remove('error');

            if (actType.value && prodType.value) {
                const exists = rulesData.find(r => r.activity === actType.value && r.product === prodType.value);
                if (exists) {
                    showToast('è¯¥ã€è®¢å•ç±»å‹ + å•†å“ç±»å‹ã€‘ç»„åˆå·²å­˜åœ¨è§„åˆ™', 'error');
                    return;
                }
            }

            const items = document.querySelectorAll('.rule-builder-item');
            if (items.length === 0) {
                document.getElementById('ruleListError').style.display = 'block';
                return;
            }
            document.getElementById('ruleListError').style.display = 'none';

            if (!isValid) return;

            // Submit
            const btn = document.getElementById('btnSaveRule');
            btn.classList.add('loading');
            
            setTimeout(() => {
                let descParts = [];
                items.forEach(item => {
                    if (item.dataset.type === 'code') descParts.push(`<span class="rule-tag">Code IN [${item.querySelector('.code-input').value}]</span>`);
                    if (item.dataset.type === 'rate') descParts.push(`<span class="rule-tag">Rate Limit</span>`);
                    if (item.dataset.type === 'total') descParts.push(`<span class="rule-tag">Total Limit</span>`);
                });

                rulesData.unshift({
                    id: 1000 + rulesData.length + 1,
                    activity: actType.value,
                    product: prodType.value,
                    descHTML: descParts.join('<span class="rule-logic-or">OR</span>'),
                    status: 'active',
                    updateTime: new Date().toISOString().slice(0, 19).replace('T', ' '),
                    operator: 'current_user'
                });
                
                renderRulesTable();
                showToast('è§„åˆ™åˆ›å»ºæˆåŠŸ', 'success');
                setTimeout(() => showToast('é…ç½®å·²ä¸‹å‘ï¼Œè§„åˆ™å®æ—¶ç”Ÿæ•ˆä¸­', 'success'), 1000);
                btn.classList.remove('loading');
                closeRuleModal();
            }, 800);
        }

        // --- WHITELIST LOGIC ---
        function renderWhitelistTable() {
            const tbody = document.querySelector('#whitelistTable tbody');
            tbody.innerHTML = '';
            whitelistData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.shopId}</td>
                    <td>${item.skuId}</td>
                    <td>${item.name}</td>
                    <td>${item.remark}</td>
                    <td>${item.operator}</td>
                    <td>${item.time}</td>
                    <td><a class="action-link delete" onclick="deleteWhitelist(${index})">ç§»å‡ºç™½åå•</a></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('whitelistPagination').innerHTML = `<span>å…±æœç´¢åˆ° ${whitelistData.length} æ¡æ•°æ®</span>`;
        }

        function openWhitelistModal() {
            document.getElementById('whitelistBatchInput').value = '';
            document.getElementById('whitelistRemark').value = '';
            document.getElementById('whitelistBatchInput').classList.remove('error');
            document.getElementById('whitelistModal').style.display = 'flex';
        }

        function closeWhitelistModal() { document.getElementById('whitelistModal').style.display = 'none'; }

        function saveWhitelistBatch() {
            const inputEl = document.getElementById('whitelistBatchInput');
            const rawText = inputEl.value.trim();
            if (!rawText) { inputEl.classList.add('error'); showToast('è¯·è¾“å…¥æ•°æ®', 'error'); return; }
            inputEl.classList.remove('error');

            const lines = rawText.split('\n');
            let validCount = 0;
            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
            const remark = document.getElementById('whitelistRemark').value.trim() || '-';

            lines.forEach(line => {
                const parts = line.split(/[,\t\s]+/);
                if (parts.length >= 2) {
                    const shopId = parts[0].trim();
                    const skuId = parts[1].trim();
                    if (/^\d+$/.test(shopId) && /^\d+$/.test(skuId)) {
                        if (!whitelistData.some(i => i.shopId === shopId && i.skuId === skuId)) {
                            whitelistData.unshift({
                                shopId, skuId, name: 'æµ‹è¯•å•†å“ ' + skuId.slice(-4), remark, operator: 'current_user', time: now
                            });
                            validCount++;
                        }
                    }
                }
            });

            if (validCount > 0) {
                renderWhitelistTable();
                showToast(`æˆåŠŸæ·»åŠ  ${validCount} æ¡ç™½åå•`, 'success');
                closeWhitelistModal();
            } else {
                showToast('æœªæ·»åŠ ä»»ä½•æ•°æ®ï¼Œå¯èƒ½æ˜¯æ ¼å¼é”™è¯¯æˆ–é‡å¤', 'warning');
            }
        }

        function deleteWhitelist(index) {
            if(confirm('ç¡®å®šè¦ç§»é™¤è¯¥ç™½åå•å—ï¼Ÿ')) {
                whitelistData.splice(index, 1);
                renderWhitelistTable();
                showToast('å·²ç§»é™¤', 'success');
            }
        }
    </script>
</body>
</html>