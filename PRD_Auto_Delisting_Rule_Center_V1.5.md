# 商品自动下架规则中心产品需求文档 (PRD)

| 文档版本 | V1.5 (最终版) |
| :--- | :--- |
| **状态** | 已定稿 |
| **最后更新** | 2026-02-09 |
| **更新内容** | 优化白名单管理交互 (合并入口、支持批量) |

---

## 1. 产品背景与目标
*   **背景**：当前业务场景中，商品在特定订单类型下可能出现配置错误、库存异常或接口报错等情况。传统人工监控响应慢，易造成客诉与资损。
*   **目标**：构建一套高灵活性、高扩展性的规则引擎，支持运营/产研人员根据“订单类型+商品类型”维度快速配置自动下架策略，实现毫秒级熔断止损。

## 2. 核心业务逻辑
系统基于 **匹配层 -> 判定层 -> 执行层** 三层架构运行。

### 2.1 规则匹配维度 (Key)
系统唯一标识一条规则的组合 Key 为：`订单类型` + `商品类型`。
*   **唯一性约束**：同一个【订单类型 + 商品类型】组合，全局只能存在一条有效规则。
*   **枚举定义**：
    *   **订单类型 (Order Type)**：
        1.  普通兑换单
        2.  自营 erp 订单
        3.  poperp 订单
        4.  erp0 元单
    *   **商品类型 (Product Type)**：
        1.  京东商品
        2.  优惠券
        3.  虚拟商品
        4.  京豆
        5.  超市卡红包
        6.  京东寄件
        7.  京东健康问诊
        8.  京东读书
        9.  爱康国宾体检
        10. 科技券
        11. PLUS异业
        12. PLUS券包

### 2.2 策略判定逻辑 (Policy)
单条规则内部包含多个“策略项 (Strategy Item)”，策略项之间为 **OR (或)** 关系，即满足任意一项策略立即触发下架。

| 策略类型 | 逻辑描述 | 配置约束 |
| :--- | :--- | :--- |
| **明确错误码阻断** | 实时监听下单/履约结果，若返回码在配置列表中，直接下架。 | 仅限添加 1 条 |
| **高频失败熔断** | `N` 秒内失败次数 > `M` 次（滑动窗口计数）。 | 仅限添加 1 条 |
| **累计失败熔断** | 商品上架后累计失败次数 > `Total` 次。 | 仅限添加 1 条 |

*   **生效机制**：配置提交后，规则需**实时生效**（Real-time Effect），无需重启服务。

## 3. 详细功能需求

### 3.1 规则中心首页 (Rule Center)
页面采用 **Tab 分页** 布局，统一管理规则与白名单。
*   **Tab 1：规则配置**
    *   功能同 V1.4，支持查询、新建、编辑、删除规则。
    *   **状态操作**：列表需提供“启用/禁用”开关，支持快速切断规则。
*   **Tab 2：白名单管理**
    *   统一在同一页面内切换，降低用户操作路径成本。

### 3.2 规则配置器 (Rule Config)
*   **表单校验**：
    *   必填项检查：订单类型、商品类型不能为空。
    *   唯一性校验：选择类型后，实时或提交时检查该组合是否已存在规则，若存在则阻断提交并提示。
    *   格式校验：错误码仅限数字/逗号；时间窗口与阈值必须为正整数。
*   **策略添加交互**：
    *   提供 [添加策略] 菜单，列出 3 种可选策略。
    *   **互斥逻辑**：已添加的策略类型在菜单中置灰不可选（标记“已添加”），确保同一种策略不重复出现。
    *   **动态删减**：支持点击策略卡片右上角的 `X` 移除该策略。
*   **提交反馈**：
    *   提交成功后，需通过 Toast 明确提示“配置已下发，规则实时生效中”。

### 3.3 自动下架白名单 (Whitelist) - 交互升级
*   **定义**：白名单机制用于豁免特定商品，使其不受自动下架规则监控。
*   **管控维度**：**店铺 ID (Shop ID) + 商品 ID (SKU ID)**。
*   **优先级**：**白名单 > 自动下架规则**。
*   **批量添加功能**：
    *   **入口**：点击 [+ 批量添加白名单] 按钮。
    *   **交互**：提供大文本输入框 (Textarea)。
    *   **格式支持**：支持 Excel 复制粘贴或手动输入，每行一条数据，格式为 `店铺ID, SKU ID` (支持逗号、空格或制表符分隔)。
    *   **容错处理**：
        *   自动过滤空行。
        *   自动校验数字格式，忽略非法行并提示用户。
        *   自动去重（包括与现有白名单重复、输入内部重复）。
    *   **统一备注**：支持为该批次添加统一的备注说明。

## 4. 非功能性需求 (NFR)
*   **实时性**：规则变更（新增/修改/删除）需在 **1秒内** 同步至所有决策节点。
*   **性能**：支持 QPS > 5000 的高并发判定，判定延迟 < 5ms。
*   **可靠性**：规则中心故障不应影响主交易流程（需降级为放行或默认兜底策略）。

## 5. 附录：数据结构示例
```json
{
  "rule_id": 1001,
  "order_type": "自营 erp 订单",
  "product_type": "京东商品",
  "strategies": {
    "error_code": {
      "enabled": true,
      "codes": [234, 502]
    },
    "rate_limit": {
      "enabled": true,
      "window_seconds": 60,
      "threshold": 1000
    },
    "total_limit": {
      "enabled": false
    }
  },
  "status": 1,
  "operator": "lixuan128",
  "update_time": "2024-05-21 09:15:00"
}
```
